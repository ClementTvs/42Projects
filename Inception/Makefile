COMPOSE = docker compose
ENV_FILE = .env
DATA_DIR = /home/ctravers/data

all: build up

check-env:
	@if [ ! -f $(ENV_FILE) ]; then \
		echo "âŒ Erreur: Le fichier .env n'existe pas !"; \
		exit 1; \
	fi

build: check-env create-dirs
	@echo "ğŸ”¨ Construction des images Docker..."
	$(COMPOSE) build

up: check-env create-dirs
	@echo "ğŸš€ DÃ©marrage des services..."
	$(COMPOSE) up -d
	@echo "âœ… Services dÃ©marrÃ©s !"
	@echo "ğŸŒ AccÃ¨de Ã  https://ctravers.42.fr"

down:
	@echo "ğŸ›‘ ArrÃªt des services..."
	$(COMPOSE) down

clean: down
	@echo "ğŸ§¹ Nettoyage des containers et rÃ©seaux..."
	docker system prune -f

fclean: down
	@echo "ğŸ’£ Suppression complÃ¨te (containers, volumes, images)..."
	$(COMPOSE) down -v --rmi all
	docker system prune -af --volumes
	@echo "ğŸ—‘ï¸  Suppression des donnÃ©es..."
	@sudo rm -rf $(DATA_DIR)/mariadb $(DATA_DIR)/wordpress

re: fclean all

logs:
	$(COMPOSE) logs -f

status:
	@echo "ğŸ“Š Statut des services:"
	docker ps --filter "name=nginx" --filter "name=wordpress" --filter "name=mariadb"

logs-nginx:
	$(COMPOSE) logs -f nginx

logs-wordpress:
	$(COMPOSE) logs -f wordpress

logs-mariadb:
	$(COMPOSE) logs -f mariadb

.PHONY: all build up down clean fclean re logs status create-dirs